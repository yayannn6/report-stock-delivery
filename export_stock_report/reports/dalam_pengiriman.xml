<odoo>
  <template id="stock_report_pengiriman">
    <t t-call="web.html_container">
      <t t-foreach="results.items()" t-as="sp">
        <t t-set="sp_name" t-value="sp[0]"/>
        <t t-set="prod_data" t-value="sp[1]"/>
        <t t-call="web.external_layout">
            <div class="page">
            <div t-att-style="'background:%s; color:#fff; text-align:center; font-weight:bold; padding:4px;' % bg_color">
                TOTAL STOK DALAM PENGIRIMAN <t t-esc="sp_name"/> <br/>
                PER TANGGAL <t t-esc="docs.end_date.strftime('%d-%m-%Y')"/>
            </div>

            <table border="1" style="width:100%;border-collapse:collapse;text-align:center;font-size:11px;">
                <thead>
                <tr>
                    <th rowspan="2">Product</th>
                    <th rowspan="2">Grade</th>
                    <t t-foreach="warehouses" t-as="wh">
                    <th colspan="2"><t t-esc="wh"/></th>
                    </t>
                    <th colspan="2">Total</th>
                </tr>
                <tr>
                    <t t-foreach="warehouses" t-as="wh">
                    <th>Box</th>
                    <th>Cont</th>
                    </t>
                    <th>Box</th>
                    <th>Cont</th>
                </tr>
                </thead>

                <tbody>
                <t t-foreach="prod_data.items()" t-as="p">
                    <t t-set="prod" t-value="p[0]"/>
                    <t t-set="wh_data" t-value="p[1]"/>

                    <t t-set="grade" t-value="None"/>
                    <t t-set="name_product" t-value="None"/>

                    <t t-foreach="warehouses" t-as="wh" t-if="wh_data.get(wh)">
                    <t t-set="grade" t-value="wh_data[wh].get('grade')"/>
                    <t t-set="name_product" t-value="wh_data[wh].get('name_product')"/>
                    <t t-break="True"/>
                    </t>

                    <t t-if="name_product">
                    <t t-set="total_box" t-value="sum(v.get('box', 0) for v in wh_data.values())"/>
                    <t t-set="total_cont" t-value="sum(v.get('cont', 0) for v in wh_data.values())"/>

                    <tr>
                        <td><t t-esc="name_product"/></td>
                        <td><t t-esc="grade or '-'"/></td>

                        <t t-foreach="warehouses" t-as="wh">
                        <t t-set="vals" t-value="wh_data.get(wh, {})"/>
                        <td><t t-esc="vals.get('box', 0)"/></td>
                        <td><t t-esc="vals.get('cont', 0)"/></td>
                        </t>

                        <td><t t-esc="int(total_box)"/></td>
                        <td><t t-esc="int(total_cont)"/></td>
                    </tr>
                    </t>
                </t>

                <!-- Grand total per warehouse -->
                <tr style="font-weight:bold; background:#f2f2f2;">
                    <td colspan="2">GRAND TOTAL</td>
                    <t t-foreach="warehouses" t-as="wh">
                    <td><t t-esc="warehouse_totals[wh]['box']"/></td>
                    <td><t t-esc="warehouse_totals[wh]['cont']"/></td>
                    </t>
                    <td><t t-esc="grand_totals['box']"/></td>
                    <td><t t-esc="grand_totals['cont']"/></td>
                </tr>
                </tbody>
            </table>
            </div>
        </t>
        </t>

      </t>
    </t>
  </template>
</odoo>
