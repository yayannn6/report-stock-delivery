<odoo>
  <template id="report_export_stock">
    <t t-call="web.html_container">
      <t t-foreach="results.items()" t-as="sp">
        <t t-set="sp_name" t-value="sp[0]"/>
        <t t-set="customers" t-value="sp[1]"/>
        <t t-call="web.external_layout">
          <div class="page">
            <div style="background:#d97c7c;color:#fff;text-align:center;font-weight:bold;padding:4px;">
              TOTAL STOK EXPORT <t t-esc="sp_name"/> <br/>
              PER TANGGAL <t t-esc="time.strftime('%d-%m-%Y')"/>
            </div>

            <t t-foreach="customers.items()" t-as="cust">
              <t t-set="cust_name" t-value="cust[0]"/>
              <t t-set="prod_data" t-value="cust[1]"/>

              <h4 style="text-align:center;">CUSTOMER : <t t-esc="cust_name"/></h4>

              <table border="1" style="width:100%;border-collapse:collapse;text-align:center;font-size:11px;">
                <thead>
                  <tr>
                    <th rowspan="2">Product</th>
                    <t t-foreach="warehouses" t-as="wh">
                      <th colspan="2"><t t-esc="wh"/></th>
                    </t>
                    <th colspan="2">Total</th>
                  </tr>
                  <tr>
                    <t t-foreach="warehouses" t-as="wh">
                      <th>QTY</th>
                      <th>UOM</th>
                    </t>
                    <th>QTY</th>
                    <th>UOM</th>
                  </tr>
                </thead>
                <tbody>
                  <t t-foreach="products" t-as="prod">
                    <tr>
                      <td><t t-esc="prod"/></td>
                      <t t-set="row_qty" t-value="0"/>
                      <t t-set="row_uom" t-value="''"/>
                      <t t-foreach="warehouses" t-as="wh">
                        <t t-set="vals" t-value="prod_data.get(prod, {}).get(wh, {})"/>
                        <td><t t-esc="vals.get('qty',0)"/></td>
                        <td><t t-esc="vals.get('uom','')"/></td>
                        <t t-set="row_qty" t-value="row_qty + vals.get('qty',0)"/>
                        <t t-if="not row_uom">
                          <t t-set="row_uom" t-value="vals.get('uom','')"/>
                        </t>
                      </t>
                      <td><t t-esc="row_qty"/></td>
                      <td><t t-esc="row_uom"/></td>
                    </tr>
                  </t>
                  <tr style="font-weight:bold;background:#eee;">
                    <td>Total</td>
                    <t t-foreach="warehouses" t-as="wh">
                      <td>
                        <t t-esc="sum([prod_data.get(p,{}).get(wh,{}).get('qty',0) for p in products])"/>
                      </td>
                      <td>
                        <t t-set="uom_val" t-value="''"/>
                        <t t-foreach="products" t-as="p">
                          <t t-if="not uom_val">
                            <t t-set="uom_val" t-value="prod_data.get(p,{}).get(wh,{}).get('uom','')"/>
                          </t>
                        </t>
                        <t t-esc="uom_val"/>
                      </td>
                    </t>
                    <td>
                      <t t-esc="sum([sum([v.get('qty',0) for v in prod_data.get(p,{}).values()]) for p in products])"/>
                    </td>
                    <td>
                      <t t-set="grand_uom" t-value="''"/>
                      <t t-foreach="products" t-as="p">
                        <t t-foreach="prod_data.get(p,{}).values()" t-as="v">
                          <t t-if="not grand_uom">
                            <t t-set="grand_uom" t-value="v.get('uom','')"/>
                          </t>
                        </t>
                      </t>
                      <t t-esc="grand_uom"/>
                    </td>
                  </tr>
                </tbody>
              </table>
              <br/>
            </t>
          </div>
        </t>
      </t>
    </t>
  </template>
</odoo>
