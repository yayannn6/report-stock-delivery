<odoo>
    <template id="stock_report_template">
        <t t-call="web.html_container">
            <div class="page">
                <t t-foreach="results.items()" t-as="sp">
                    <t t-set="salesperson" t-value="sp[0]"/>
                    <t t-set="customers" t-value="sp[1]"/>
                    <t t-call="web.external_layout">
                        <div t-att-style="'background:%s; color:#fff; text-align:center; font-weight:bold; padding:4px;' % bg_color">
                            REPORT PERSEDIAAN BARANG LUPI<br/>
                            PER TANGGAL <t t-esc="docs.end_date.strftime('%d-%m-%Y')"/>
                        </div>

                        <t t-foreach="customers.items()" t-as="cust">
                            <t t-set="cust_name" t-value="cust[0]"/>
                            <t t-set="prod_data" t-value="cust[1]"/>

                            <h4 style="text-align:center;">CUSTOMER : <t t-esc="cust_name"/></h4>

                            <table border="1" style="width:100%;border-collapse:collapse;text-align:center;font-size:11px;">
                                <thead>
                                    <tr>
                                        <th rowspan="2">Product</th>
                                        <th rowspan="2">Grade</th>
                                        <t t-foreach="warehouses" t-as="wh">
                                            <th colspan="2"><t t-esc="wh"/></th>
                                        </t>
                                        <th colspan="2">Total</th>
                                    </tr>
                                    <tr>
                                        <t t-foreach="warehouses" t-as="wh">
                                            <th>Box</th>
                                            <th>Cont</th>
                                        </t>
                                        <th>Box</th>
                                        <th>Cont</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="prod_data.items()" t-as="prod_rec">
                                        <t t-set="prod_name" t-value="prod_rec[0]"/>
                                        <t t-set="wh_data" t-value="prod_rec[1]"/>

                                        <tr>
                                            <td style="text-align:left; padding-left:6px;"><t t-esc="wh_data[list(wh_data.keys())[0]].get('name_product')"/></td>
                                            <td><t t-esc="wh_data[list(wh_data.keys())[0]].get('grade') or '-'"/></td>

                                            <t t-set="total_box" t-value="0"/>
                                            <t t-set="total_cont" t-value="0"/>
                                            <t t-foreach="warehouses" t-as="wh">
                                                <t t-set="vals" t-value="wh_data.get(wh, {})"/>
                                                <td><t t-esc="vals.get('box', 0)"/></td>
                                                <td><t t-esc="vals.get('cont', 0)"/></td>
                                                <t t-set="total_box" t-value="total_box + vals.get('box', 0)"/>
                                                <t t-set="total_cont" t-value="total_cont + vals.get('cont', 0)"/>
                                            </t>

                                            <td><t t-esc="total_box"/></td>
                                            <td><t t-esc="total_cont"/></td>
                                        </tr>

                                        <!-- TOTAL per base product -->
                                        <t t-set="base_name" t-value="prod_name.split('(')[0].strip()"/>
                                        <t t-if="not any(other != prod_name and (other.split('(')[0].strip() == base_name) for other in prod_data)">
                                            <tr style="font-weight:bold; background:#f5f5f5;">
                                                <td colspan="2" style="text-align:left; padding-left:6px;">TOTAL <t t-esc="base_name"/></td>
                                                <t t-foreach="warehouses" t-as="wh">
                                                    <td><t t-esc="int(product_group_totals.get(cust_name, {}).get(base_name, {}).get(wh, {}).get('box', 0))"/></td>
                                                    <td><t t-esc="int(product_group_totals.get(cust_name, {}).get(base_name, {}).get(wh, {}).get('cont', 0))"/></td>
                                                </t>
                                                <td><t t-esc="int(product_group_totals.get(cust_name, {}).get(base_name, {}).get('total', {}).get('box', 0))"/></td>
                                                <td><t t-esc="int(product_group_totals.get(cust_name, {}).get(base_name, {}).get('total', {}).get('cont', 0))"/></td>
                                            </tr>
                                        </t>
                                    </t>

                                    <!-- TOTAL PER CUSTOMER -->
                                    <tr style="font-weight:bold;">
                                        <td colspan="2">TOTAL <t t-esc="cust_name"/></td>
                                        <t t-foreach="warehouses" t-as="wh">
                                            <td><t t-esc="int(customer_totals.get(salesperson, {}).get(cust_name, {}).get('box', 0))"/></td>
                                            <td><t t-esc="int(customer_totals.get(salesperson, {}).get(cust_name, {}).get('cont', 0))"/></td>
                                        </t>
                                        <td><t t-esc="int(customer_totals.get(salesperson, {}).get(cust_name, {}).get('box', 0))"/></td>
                                        <td><t t-esc="int(customer_totals.get(salesperson, {}).get(cust_name, {}).get('cont', 0))"/></td>
                                    </tr>
                                </tbody>
                            </table>
                            <br/>
                        </t>
                    </t>
                </t>
            </div>
        </t>
    </template>
</odoo>
