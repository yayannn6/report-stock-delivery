<odoo>
    <template id="stock_report_template">
        <t t-call="web.html_container">
            <div class="page">
                <t t-foreach="results.items()" t-as="sp">
                    <t t-set="salesperson" t-value="sp[0]"/>
                    <t t-set="customers" t-value="sp[1]"/>
                    <t t-call="web.external_layout">
                        
                        <div t-att-style="'background:%s; color:#fff; text-align:center; font-weight:bold; padding:4px;' % bg_color">
                            REPORT PERSEDIAAN BARANG <t t-esc="salesperson"/> <br/>
                            PER TANGGAL <t t-esc="docs.end_date.strftime('%d-%m-%Y')"/>
                        </div>

                        <t t-foreach="customers.items()" t-as="cust">
                            <t t-set="cust_name" t-value="cust[0]"/>
                            <t t-set="prod_data" t-value="cust[1]"/>

                            <h4 style="text-align:center;">CUSTOMER : <t t-esc="cust_name"/></h4>

                            <table border="1" style="width:100%;border-collapse:collapse;text-align:center;font-size:11px;">
                                <thead>
                                    <tr>
                                        <th rowspan="2">Product</th>
                                        <th rowspan="2">Grade</th>
                                        <t t-foreach="warehouses" t-as="wh">
                                            <th colspan="2"><t t-esc="wh"/></th>
                                        </t>
                                        <th colspan="2">Total</th>
                                    </tr>
                                    <tr>
                                        <t t-foreach="warehouses" t-as="wh">
                                            <th>Box</th>
                                            <th>Cont</th>
                                        </t>
                                        <th>Box</th>
                                        <th>Cont</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Filter produk -->
                                    <t t-set="products_in_cust" t-value="[p for p in products if p in prod_data]"/>

                                    <!-- Inisialisasi -->
                                    <t t-set="prev_base" t-value="''"/>
                                    <t t-set="subtotal_box" t-value="0"/>
                                    <t t-set="subtotal_cont" t-value="0"/>
                                    <t t-set="wh_totals" t-value="dict((wh, {'box': 0, 'cont': 0}) for wh in warehouses)"/>

                                    <!-- Loop produk -->
                                    <t t-foreach="products_in_cust" t-as="prod">
                                        <t t-set="base_name" t-value="prod.split('(')[0].strip()"/>
                                        <t t-set="total_box" t-value="0"/>
                                        <t t-set="total_cont" t-value="0"/>
                                        <t t-set="grade" t-value="None"/>
                                        <t t-set="name_product" t-value="None"/>

                                        <!-- ambil info produk -->
                                        <t t-foreach="warehouses" t-as="wh" t-if="prod_data.get(prod, {}).get(wh)">
                                            <t t-set="grade" t-value="prod_data[prod][wh].get('grade')"/>
                                            <t t-set="name_product" t-value="prod_data[prod][wh].get('name_product')"/>
                                            <t t-break="True"/>
                                        </t>

                                        <t t-if="name_product">
                                            <tr>
                                                <td style="text-align:left; padding-left:6px;">
                                                    <t t-esc="base_name if base_name != prev_base else ''"/>
                                                </td>
                                                <td><t t-esc="grade or '-'"/></td>

                                                <!-- isi per warehouse -->
                                                <t t-foreach="warehouses" t-as="wh">
                                                    <t t-set="vals" t-value="prod_data.get(prod, {}).get(wh, {})"/>
                                                    <t t-set="val_box" t-value="vals.get('box', 0)"/>
                                                    <t t-set="val_cont" t-value="vals.get('cont', 0)"/>

                                                    <td><t t-esc="'%d' % val_box"/></td>
                                                    <td><t t-esc="'%.2f' % val_cont"/></td>

                                                    <!-- Tambahkan ke total varian -->
                                                    <t t-set="total_box" t-value="total_box + val_box"/>
                                                    <t t-set="total_cont" t-value="total_cont + val_cont"/>

                                                    <!-- Tambahkan ke subtotal warehouse -->
                                                    <t t-set="old_box" t-value="wh_totals[wh]['box']"/>
                                                    <t t-set="old_cont" t-value="wh_totals[wh]['cont']"/>
                                                    <t t-set="wh_totals" t-value="dict(list(wh_totals.items()) + [(wh, {'box': old_box + val_box, 'cont': old_cont + val_cont})])"/>
                                                </t>

                                                <!-- total varian -->
                                                <td><t t-esc="'%d' % total_box"/></td>
                                                <td><t t-esc="'%.2f' % total_cont"/></td>

                                                <!-- total produk -->
                                                <t t-set="subtotal_box" t-value="subtotal_box + total_box"/>
                                                <t t-set="subtotal_cont" t-value="subtotal_cont + total_cont"/>
                                            </tr>
                                        </t>

                                        <!-- Cek akhir grup produk -->
                                        <t t-set="is_last_of_group"
                                        t-value="(products_in_cust.index(prod) == len(products_in_cust) - 1) or (products_in_cust[products_in_cust.index(prod) + 1].split('(')[0].strip() != base_name)"/>

                                        <t t-if="is_last_of_group">
                                            <tr style="font-weight:bold; background-color:#f0f0f0; border-top:2px solid #000;">
                                                <td colspan="2" style="text-align:left; padding-left:6px;">
                                                    TOTAL <t t-esc="base_name"/>
                                                </td>

                                                <!-- total per warehouse -->
                                                <t t-foreach="warehouses" t-as="wh">
                                                    <td><t t-esc="'%d' % wh_totals[wh]['box']"/></td>
                                                    <td><t t-esc="'%.2f' % wh_totals[wh]['cont']"/></td>
                                                </t>

                                                <!-- total keseluruhan -->
                                                <td><t t-esc="'%d' % subtotal_box"/></td>
                                                <td><t t-esc="'%.2f' % subtotal_cont"/></td>
                                            </tr>

                                            <!-- reset subtotal -->
                                            <t t-set="subtotal_box" t-value="0"/>
                                            <t t-set="subtotal_cont" t-value="0"/>
                                            <t t-set="wh_totals" t-value="dict((wh, {'box': 0, 'cont': 0}) for wh in warehouses)"/>
                                        </t>

                                        <t t-set="prev_base" t-value="base_name"/>
                                    </t>
                                    <tr style="font-weight:bold;">
                                            <td colspan="2">GRAND TOTAL</td>
                                            <t t-foreach="warehouses" t-as="wh">
                                                <td>
                                                <t t-esc="'%d' % customer_totals.get(salesperson, {}).get(cust_name, {}).get(wh, {}).get('box', 0)"/>
                                                </td>
                                                <td>
                                                <t t-esc="'%.2f' % customer_totals.get(salesperson, {}).get(cust_name, {}).get(wh, {}).get('cont', 0)"/>
                                                </td>
                                            </t>
                                            <td>
                                                <t t-esc="'%d' % customer_totals.get(salesperson, {}).get(cust_name, {}).get('total', {}).get('box', 0)"/>
                                            </td>
                                            <td>
                                                <t t-esc="'%.2f' % customer_totals.get(salesperson, {}).get(cust_name, {}).get('total', {}).get('cont', 0)"/>
                                            </td>
                                        </tr>
                                </tbody>


                            </table>
                            <br/>
                        </t>
                    </t>
                </t>
            </div>

            <!-- Halaman Total Keseluruhan Per Warehouse (GRAND TOTAL) -->
            <t t-call="web.external_layout">
                <div class="page">
                    <h3 style="text-align:center; font-weight:bold; color:black;">
                        GRAND TOTAL PER CUSTOMER
                    </h3>

                    <table style="width:100%; border-collapse:collapse; border:1px solid black; color:black;">
                    <thead>
                        <tr style="border:1px solid black;">
                            <th style="border:1px solid black; text-align:center;">CUSTOMER</th>
                            <t t-foreach="warehouses" t-as="wh">
                                <th style="border:1px solid black; text-align:center;" colspan="2">
                                    <t t-esc="wh"/>
                                </th>
                            </t>
                            <th style="border:1px solid black; text-align:center;" colspan="2">TOTAL</th>
                        </tr>
                        <tr style="border:1px solid black;">
                            <t t-foreach="warehouses" t-as="wh">
                                <th style="border:1px solid black; text-align:center;">BOX</th>
                                <th style="border:1px solid black; text-align:center;">CONT</th>
                            </t>
                            <th style="border:1px solid black; text-align:center;">BOX</th>
                            <th style="border:1px solid black; text-align:center;">CONT</th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-foreach="customer_totals.items()" t-as="sales_data">
                            <t t-set="salesperson" t-value="sales_data[0]"/>
                            <t t-set="customers" t-value="sales_data[1]"/>

                            <t t-foreach="customers.items()" t-as="cust_data">
                                <t t-set="cust_name" t-value="cust_data[0]"/>
                                <t t-set="cust_val" t-value="cust_data[1]"/>

                                <tr>
                                    <td style="border:1px solid black; padding:3px;">
                                        <t t-esc="cust_name"/>
                                    </td>
                                    <t t-foreach="warehouses" t-as="wh">
                                        <td style="border:1px solid black; text-align:right; padding:3px;">
                                            <t t-esc="('%.0f' % cust_val.get(wh, {}).get('box', 0))"/>
                                        </td>
                                        <td style="border:1px solid black; text-align:right; padding:3px;">
                                            <t t-esc="('%.2f' % cust_val.get(wh, {}).get('cont', 0))"/>
                                        </td>
                                    </t>
                                    <td style="border:1px solid black; text-align:right; font-weight:bold;">
                                        <t t-esc="('%.0f' % cust_val.get('total', {}).get('box', 0))"/>
                                    </td>
                                    <td style="border:1px solid black; text-align:right; font-weight:bold;">
                                        <t t-esc="('%.2f' % cust_val.get('total', {}).get('cont', 0))"/>
                                    </td>
                                </tr>
                            </t>

                            <!-- Baris GRAND TOTAL -->
                            <tr style="font-weight:bold;">
                                <td style="border:1px solid black; text-align:center;">GRAND TOTAL</td>
                                <t t-foreach="warehouses" t-as="wh">
                                    <td style="border:1px solid black; text-align:right;">
                                        <t t-esc="('%.0f' % warehouse_totals[wh]['box'])"/>
                                    </td>
                                    <td style="border:1px solid black; text-align:right;">
                                        <t t-esc="('%.2f' % warehouse_totals[wh]['cont'])"/>
                                    </td>
                                </t>
                                <td style="border:1px solid black; text-align:right;">
                                    <t t-esc="('%.0f' % grand_totals['box'])"/>
                                </td>
                                <td style="border:1px solid black; text-align:right;">
                                    <t t-esc="('%.2f' % grand_totals['cont'])"/>
                                </td>
                            </tr>
                        </tbody>
                </table>


                    <!-- <t t-if="docs.kategori_selection == 'export'">
                        <t t-foreach="uoms" t-as="uom">
                            <t t-set="uom_name" t-value="uom['name']"/>
                            <t t-set="uom_data" t-value="total_per_uom_warehouse.get(uom_name, {})"/>

                            <t t-if="uom_data">
                                <h4 style="margin-top:10px; font-weight:bold;">
                                TOTAL PER WAREHOUSE (UoM: <t t-esc="uom_name"/>)
                                </h4>

                                <table style="border-collapse:collapse; width:100%; font-size:13px; margin-bottom:10px;">
                                <thead>
                                    <tr style="background:#eee; font-weight:bold;">
                                    <th style="border:1px solid #666; padding:4px;">Product</th>
                                    <th style="border:1px solid #666; padding:4px;">Grade</th>
                                    <t t-foreach="warehouses" t-as="wh">
                                        <th style="border:1px solid #666; padding:4px;">
                                        <t t-esc="wh"/>
                                        </th>
                                    </t>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="uom_data.items()" t-as="prod_item">
                                    <t t-set="prod_name" t-value="prod_item[0]"/>
                                    <t t-set="wh_data" t-value="prod_item[1]"/>

                                    <tr>
                                        <td style="border:1px solid #666; padding:4px;">
                                        <t t-esc="prod_name"/>
                                        </td>
                                        <td style="border:1px solid #666; padding:4px;">
                                            <t t-set="first_wh" t-value="(wh_data and list(wh_data.values())[0]) or {}"/>
                                            <t t-esc="first_wh.get('grade', '')"/>
                                        </td>

                                        <t t-foreach="warehouses" t-as="wh">
                                        <td style="border:1px solid #666; padding:4px; text-align:right;">
                                            <t t-esc="'%.2f' % wh_data.get(wh, {}).get('converted', 0)"/>
                                        </td>
                                        </t>
                                    </tr>
                                    </t>
                                </tbody>
                                </table>
                            </t>
                            </t>

                    </t> -->
                    <!-- <t t-else=""> -->
                        <!-- <h3 class="text-center mt-4 mb-2">TOTAL KESELURUHAN PER WAREHOUSE</h3>
                        <table class="table table-bordered table-sm" style="width:100%; text-align:right; border-collapse: collapse;">
                            <thead style="background-color:#eaeaea; text-align:center;">
                                <tr>
                                    <th style="padding:6px;">Warehouse</th>
                                    <t t-foreach="uoms_new" t-as="uom">
                                        <th style="padding:6px;"><t t-esc="uom['name']"/></th>
                                    </t>
                                    <th style="padding:6px;">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="total_warehouse_summary_new.items()" t-as="wh">
                                    <tr>
                                        <td style="padding:6px; text-align:left;"><t t-esc="wh[0]"/></td>
                                        <t t-foreach="uoms_new" t-as="uom">
                                            <td style="padding:6px;"><t t-esc="int(wh[1].get(uom['name'], 0))"/></td>
                                        </t>
                                        <td style="padding:6px; font-weight:bold;"><t t-esc="int(wh[1].get('Total Count (BOX)', 0))"/></td>
                                    </tr>
                                </t>
                            </tbody>
                        </table> -->


                    <!-- </t> -->
                    
                    

                    

                </div>
            </t>
        </t>
    </template>
</odoo>
